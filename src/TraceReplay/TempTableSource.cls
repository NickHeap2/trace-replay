USING ABLContainer.Logging.* FROM PROPATH.
USING System.IO.* FROM ASSEMBLY.
USING Progress.Lang.*.
USING Settings.* FROM PROPATH.
USING TraceReplay.* FROM PROPATH.

BLOCK-LEVEL ON ERROR UNDO, THROW.

CLASS TraceReplay.TempTableSource:

  DEFINE VARIABLE hStaticTempTables AS HANDLE NO-UNDO.
  DEFINE VARIABLE countQuery AS HANDLE NO-UNDO.

  DEFINE TEMP-TABLE CreatedTempTable NO-UNDO
    FIELD tableName AS CHARACTER
    FIELD ttHandle AS HANDLE
    FIELD sourceFile AS CHARACTER
    FIELD wasUsed AS LOGICAL
    INDEX iPrimary IS PRIMARY tableName.

  DEFINE PUBLIC PROPERTY TempTableDefinitions AS TempTableDefinitions NO-UNDO
  GET.
  SET.

  CONSTRUCTOR TempTableSource ():
    TempTableDefinitions = NEW TempTableDefinitions().
    IF Settings:Application:StaticTempTableProcedure <> "" THEN DO:
      RUN VALUE(Settings:Application:StaticTempTableProcedure) PERSISTENT SET hStaticTempTables.
    END.
  END CONSTRUCTOR.

    CREATE QUERY countQuery.

  END CONSTRUCTOR.

  METHOD PUBLIC VOID EmptyTempTables():
    Log:Information("Emptying temp-tables...").
    FOR EACH CreatedTempTable:
      CreatedTempTable.ttHandle:DEFAULT-BUFFER-HANDLE:EMPTY-TEMP-TABLE().
    END.
  END METHOD.

  METHOD PUBLIC INTEGER CountTableRecords(tempTableHandle AS HANDLE):
    DEFINE VARIABLE recordCount AS INTEGER NO-UNDO.

    countQuery:SET-BUFFERS(tempTableHandle:DEFAULT-BUFFER-HANDLE).
    countQuery:QUERY-PREPARE(SUBSTITUTE("FOR EACH &1 NO-LOCK", tempTableHandle:NAME)).
    countQuery:QUERY-OPEN().
    recordCount = 0.
    countQuery:GET-NEXT().
    DO WHILE countQuery:QUERY-OFF-END = FALSE:
      recordCount = recordCount + 1.
      countQuery:GET-NEXT().
    END.
    countQuery:QUERY-CLOSE().

    RETURN recordCount.
  END METHOD.

  METHOD PUBLIC HANDLE GetTempTable(tempTableName AS CHARACTER, sourceProcedure AS CHARACTER, sourceInternalProcedure AS CHARACTER):
    DEFINE VARIABLE tableName AS CHARACTER NO-UNDO.
    DEFINE VARIABLE tempTableHandle AS HANDLE NO-UNDO.

    tableName = REPLACE(tempTableName, "tt_", "").

    FIND FIRST CreatedTempTable
      WHERE CreatedTempTable.tableName = tempTableName
      NO-LOCK NO-ERROR.
    IF AVAILABLE CreatedTempTable THEN DO:
      tempTableHandle = CreatedTempTable.ttHandle.
      Log:Debug("            Using temp-table 藻眇葬忪逦犴妣骝镯汜汨瀹孪亘翦眇葬忪逦犴濠┊盼漠盘优南田绾腻怩绋抿遽糸铉翦眇翎忪藻眇葬忪逦犴妣孪亘翦眇葬忪逦犴濠┊靡帕耘耘托粤绿翦眇葬忪迦犷潇晌咨那旁邢咸⒃屙鹪徕戾酗镬翦眇葬忪迦犷潇搴靡帕耘躺伺翦眇葬忪逦犴濠蜗乓蚁耶善乓蚁噎釉猎沼号乙弦匀盼南呐膛耘下逝迷翦眇葬忪迦犷潇瀹靡帕耘耘托粤绿翦眇葬忪迦犷潇晌咨那旁邢咸⒃屙鹪徕戾酗镬翦眇葬忪迦犷潇搴靡帕耘躺伺翎忪逦犴濠蜗乓蚁耶善乓蚁噎釉猎沼号乙弦匀盼南翦眇葬忪迦犷潇清粼屙鹪徕戾乞镯语躜沐翦眇葬忪逦犴瀣箫躜沐序镢邃躜濠田绾膨蝻颞乓蚁液膨蝻蛲弩筢珏...", BOX(ERROR-STATUS:GET-MESSAGE(1))).
          RETURN ?.
        END.
      END.

      tempTableHandle:TEMP-TABLE-PREPARE(tempTableName).
      tempTableHandle:UNDO = FALSE.

      CacheTempTable(tempTableName, tempTableHandle).
    END.

    /* clear current results in certain cases */
    IF sourceProcedure = "trno.p"
      AND sourceInternalProcedure = "GetResultsTRNO"
    THEN DO:
      tempTableHandle:DEFAULT-BUFFER-HANDLE:EMPTY-TEMP-TABLE().
    END.
    RETURN tempTableHandle.

  END METHOD.

  METHOD PUBLIC HANDLE GetTempTableFromSource(tempTableName AS CHARACTER, sourceProcedure AS CHARACTER):
    RETURN ?.
  END METHOD.

  METHOD PUBLIC VOID CacheTempTable (tempTableName AS CHARACTER, tableHandle AS HANDLE, sourceFile AS CHARACTER):
    IF NOT CAN-FIND(FIRST CreatedTempTable WHERE CreatedTempTable.tableName = LC(tempTableName)) THEN DO:
      Log:Debug("    Caching temp-table 藻眇葬忪逦犴妣鏖翳熙礅弪湘崎屐潴 fields", BOX(tempTableName), BOX(tableHandle:DEFAULT-BUFFER-HANDLE:NUM-FIELDS)).
      CREATE CreatedTempTable.
      ASSIGN
        CreatedTempTable.tableName = LC(tempTableName)
        CreatedTempTable.ttHandle = tableHandle
        CreatedTempTable.sourceFile = sourceFile.
    END.
  END METHOD.

  METHOD VOID LogTableRecordCount(direction AS CHARACTER, temptableHandle AS HANDLE):
    DEFINE VARIABLE recordCount AS INTEGER NO-UNDO.
    recordCount = CountTableRecords(tempTableHandle).
    DEFINE VARIABLE directionText AS CHARACTER NO-UNDO.
    IF direction MATCHES "*INPUT*" THEN DO:
      directionText = "Passing".
    END.
    ELSE DO:
      directionText = "Received".
    END.

    IF recordCount > 0 THEN DO:
      Log:Information("        拈蝈泗轱铪义泔蜾蔑躅酤蝈泔蜾螬轭翦眇翎忪藻眇葬忪逦犴妣孪亘溟蝈泗轱钤屮舂孪亘蝈泔蜾蔑躅舂孪亘翦眇葬忪迦犷潇搴瘟团┅盼漠盼团匀夏团匀夏窒赡田缭徕戾义泔蜾蟥翦眇翎忪迦犷潇劣攘文膛┖呐粕闻至疑谅膛蝈泔蜾蔑躅劣晌耘桥蜗瘴南呐粕闻至疑谅膛翦眇葬忪迓蹑驽劣攘文膛蜗瘴南呐粕闻至疑谅膛溟箴灬义泔蜾筇轫轸劣晌耘桥蜗瘴南溟箴灬义泔蜾筇轫轸渝趑轭珞毫痧扉汜糸镱耗轶痨狴义泔蜾筇轫轸翦眇葬忪迓蹑驽翦眇翎忪迦犷潇搴呐屏仗原抡破乓攘文膛泔躅粞蹂蝙河旁抡破乓莹翦眇葬忪迓蹑驽颟泔躅粞蹂蝙貉张屹幸判烈浓诱掠陨哉耘á葡帕萌Ρ蜗滔盟翦眇葬忪迦犷潇搴瘟团┅泔躅粞蹂蝙貉张屹闲盼ī蝈泔蜾蔑躅爱泔躅粞蹂蝙呵旁闻卦ī咭琶弦挠南兹商泔躅粞蹂蝙貉张屹掀骗盼屏逃藕蝈泔蜾蔑躅蝈泔蜾蔑躅碑田缫邈矧洙蝈泔蜾蔑躅衄翦眇葬忪迓蹑驽颟善蝈泔蜾蔑躅窘溟箴灬义泔蜾筇轫轸匀盼膛林咭琶弦挠泔躅粞蹂蝙呵旁闻卦ī盼漠泔躅粞蹂蝙貉张屹锰嫌浓┊盼团匀夏团匀夏窒赡田缫邈矧洙蝈泔蜾熙礅弪劣晌耘桥椰蝈泔蜾迈骀弪劣攘文膛┖呐粕闻至疑谅膛翳轶崎屐劣晌耘桥蜗瘴南呐粕闻至疑谅膛怩骀弪崎屐淙犷潇劣攘文膛蜗瘴南田绾深骘蝽狒轱瞑义泔蜾铛礅弪义泔蜾熙礅弪:", BOX(recordNumber)).
    DO thisField = 1 TO recordBuffer:NUM-FIELDS:
      bufferFieldHandle = recordBuffer:BUFFER-FIELD(thisField).
      Log:Information("            崎屐湮犴妣桔崎屐渲犰蹂]", BOX(bufferFieldHandle:NAME), BOX(bufferFieldHandle:BUFFER-VALUE())).
    END.

  END METHOD.

END CLASS.